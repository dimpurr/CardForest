# CardForest Card List View 开发任务追踪

## 相关文档

重要！！干任何事情之前必读 cardforest/packages/docs/gpt/memo.md

### 设计文档
- 主要设计文档: `/packages/docs/src/guide/README.md`
- 卡片内容设计: `/packages/docs/src/guide/card_content_and_relations.md`
- 技术架构概览: `/packages/docs/src/tech/architecture.md`

## 开发目标

实现一个类 Notion 的强大卡片列表界面，支持多种视图模式和高级交互功能。

### 1. 基础架构
- [x] 集成 TanStack Table
  - [x] 设置基础配置
    - [x] 创建 TableProvider 组件
    - [x] 配置 columnDefs 和 data 接口
    - [x] 实现基础表格渲染
  - [ ] 实现虚拟滚动
    - [x] 配置 @tanstack/react-virtual
    - [x] 实现行虚拟化
    - [ ] 实现列虚拟化（可选）
    - [ ] 优化滚动性能
  - [x] 实现排序和过滤
    - [x] 实现列排序功能
    - [x] 实现过滤器界面
    - [x] 实现过滤逻辑
    - [ ] 支持多列排序
  - [x] 实现列自定义
    - [x] 列显示/隐藏控制
    - [x] 列顺序调整
    - [x] 列宽调整
  - [ ] 实现拖拽排序
    - [ ] 列拖拽排序
    - [ ] 处理排序持久化
- [ ] 实现视图切换系统
  - [ ] 视图状态管理
    - [ ] 创建视图状态 atom
    - [ ] 实现视图切换逻辑
    - [ ] 处理视图切换动画
  - [ ] 视图配置持久化
    - [ ] 设计视图配置数据结构
    - [ ] 实现配置序列化/反序列化
    - [ ] 集成本地存储
  - [ ] 视图切换动画
    - [ ] 设计视图切换动画
    - [ ] 实现平滑过渡效果
    - [ ] 优化动画性能
- [ ] 字段动态配置
  - [ ] 字段类型识别
    - [ ] 实现字段类型系统
    - [ ] 支持基础类型（文本、数字、日期等）
    - [ ] 支持复杂类型（关系、文件等）
  - [ ] 字段选择器
    - [ ] 创建字段选择UI
    - [ ] 实现字段搜索和过滤
    - [ ] 支持字段拖拽排序
  - [ ] 视图字段映射
    - [ ] 实现字段到视图的映射逻辑
    - [ ] 支持不同视图的字段配置
    - [ ] 处理字段映射持久化

### 2. 表格视图 (Table)
- [ ] 基础功能
  - [ ] 列配置和调整
    - [ ] 实现列宽拖拽调整
    - [ ] 支持列顺序调整
    - [ ] 列显示/隐藏控制
  - [ ] 单元格编辑
    - [ ] 实现单元格点击编辑
    - [ ] 支持不同类型的编辑器
    - [ ] 实现编辑验证和保存
  - [ ] 行选择和批量操作
    - [ ] 实现行选择功能
    - [ ] 支持多选和范围选择
    - [ ] 实现批量操作菜单
  - [ ] 排序和过滤
    - [ ] 实现列排序
    - [ ] 支持多列排序
    - [ ] 实现过滤面板
- [ ] 高级功能
  - [ ] 列固定
    - [ ] 实现左侧列固定
    - [ ] 实现右侧列固定
    - [ ] 处理固定列滚动
  - [ ] 列分组
    - [ ] 实现列分组UI
    - [ ] 支持分组展开/折叠
    - [ ] 处理分组数据聚合
  - [ ] 行展开/折叠
    - [ ] 实现行展开/折叠UI
    - [ ] 支持子行数据加载
    - [ ] 处理展开状态持久化
  - [ ] 自定义列宽
    - [ ] 实现列宽拖拽
    - [ ] 支持最小/最大宽度
    - [ ] 处理列宽持久化
  - [ ] 快捷键支持
    - [ ] 实现导航快捷键
    - [ ] 支持编辑快捷键
    - [ ] 支持操作快捷键

### 3. 看板视图 (Kanban)
- [ ] 基础功能
  - [ ] 动态字段分组
    - [ ] 实现分组逻辑
    - [ ] 支持自定义分组规则
    - [ ] 处理分组数据更新
  - [ ] 卡片拖拽
    - [ ] 集成 react-beautiful-dnd
    - [ ] 实现列间拖拽
    - [ ] 实现列内排序
  - [ ] 状态切换
    - [ ] 实现状态切换UI
    - [ ] 处理状态变更逻辑
    - [ ] 支持自定义状态
  - [ ] 卡片预览
    - [ ] 实现预览模式
    - [ ] 支持快速操作
    - [ ] 优化加载体验
- [ ] 高级功能
  - [ ] 自定义分组
    - [ ] 实现分组配置UI
    - [ ] 支持复杂分组规则
    - [ ] 处理分组配置持久化
  - [ ] 列折叠
    - [ ] 实现列折叠UI
    - [ ] 处理折叠状态
    - [ ] 优化性能
  - [ ] WIP 限制
    - [ ] 实现WIP配置
    - [ ] 处理限制验证
    - [ ] 显示警告提示
  - [ ] 批量操作
    - [ ] 实现多选功能
    - [ ] 支持批量拖拽
    - [ ] 实现批量编辑

### 4. 画廊视图 (Gallery)
- [ ] 基础功能
  - [ ] 网格布局
    - [ ] 实现响应式网格
    - [ ] 支持不同尺寸
    - [ ] 优化布局性能
  - [ ] 图片预览
    - [ ] 实现图片预览模态框
    - [ ] 支持图片缩放
    - [ ] 处理图片加载错误
  - [ ] 卡片信息展示
    - [ ] 设计卡片布局
    - [ ] 显示关键信息
    - [ ] 支持自定义字段
  - [ ] 动态主图选择
    - [ ] 实现主图选择UI
    - [ ] 支持多图片源
    - [ ] 处理图片回退
- [ ] 高级功能
  - [ ] 自适应布局
    - [ ] 实现瀑布流布局
    - [ ] 支持动态调整
    - [ ] 优化重排性能
  - [ ] 懒加载优化
    - [ ] 实现图片懒加载
    - [ ] 支持预加载
    - [ ] 优化加载体验
  - [ ] 图片裁剪
    - [ ] 实现裁剪功能
    - [ ] 支持多种比例
    - [ ] 处理裁剪缓存
  - [ ] 排序和过滤
    - [ ] 实现排序选项
    - [ ] 支持多维过滤
    - [ ] 优化筛选性能

### 5. 信息流视图 (Stream)
- [ ] 基础功能
  - [ ] 时间轴布局
    - [ ] 实现时间轴UI
    - [ ] 支持时间分组
    - [ ] 处理时区问题
  - [ ] 无限滚动
    - [ ] 实现滚动加载
    - [ ] 优化性能
    - [ ] 处理加载状态
  - [ ] 卡片预览
    - [ ] 实现预览模式
    - [ ] 支持快速操作
    - [ ] 优化加载体验
  - [ ] 快速操作
    - [ ] 实现操作菜单
    - [ ] 支持快捷键
    - [ ] 处理操作响应
- [ ] 高级功能
  - [ ] 智能分组
    - [ ] 实现自动分组
    - [ ] 支持自定义规则
    - [ ] 优化分组逻辑
  - [ ] 内容摘要
    - [ ] 实现摘要生成
    - [ ] 支持自定义长度
    - [ ] 优化显示效果
  - [ ] 交互动画
    - [ ] 实现滚动动画
    - [ ] 支持展开动画
    - [ ] 优化动画性能
  - [ ] 上下文预加载
    - [ ] 实现预加载逻辑
    - [ ] 优化加载策略
    - [ ] 处理缓存失效

### 6. 文章连读视图 (Reader)
- [ ] 基础功能
  - [ ] 长文阅读模式
    - [ ] 实现阅读界面
    - [ ] 支持字体设置
    - [ ] 优化阅读体验
  - [ ] 文章导航
    - [ ] 实现目录导航
    - [ ] 支持快速跳转
    - [ ] 处理锚点定位
  - [ ] 阅读进度
    - [ ] 实现进度指示
    - [ ] 支持进度保存
    - [ ] 处理同步问题
  - [ ] 大纲导航
    - [ ] 实现大纲提取
    - [ ] 支持层级展示
    - [ ] 处理导航交互
- [ ] 高级功能
  - [ ] 双栏布局
    - [ ] 实现双栏显示
    - [ ] 支持宽度调整
    - [ ] 优化响应式
  - [ ] 文章关联
    - [ ] 实现关联推荐
    - [ ] 支持手动关联
    - [ ] 处理关联更新
  - [ ] 笔记标注
    - [ ] 实现标注功能
    - [ ] 支持多种样式
    - [ ] 处理标注同步
  - [ ] 阅读位置记忆
    - [ ] 实现位置保存
    - [ ] 支持多设备同步
    - [ ] 处理恢复逻辑

## 技术方案

### 核心组件选择
- 表格引擎：TanStack Table
- 虚拟滚动：@tanstack/react-virtual
- 拖拽支持：react-beautiful-dnd
- 状态管理：jotai
- UI组件：radix-ui

### 数据流设计
1. 数据源层
   ```typescript
   interface DataSource {
     fetch(): Promise<CardRecord[]>;
     update(changes: Change[]): Promise<void>;
     subscribe(callback: (changes: Change[]) => void): () => void;
   }
   ```

2. 视图层
   ```typescript
   interface ViewConfig {
     type: 'table' | 'kanban' | 'gallery' | 'stream' | 'reader';
     settings: {
       columns?: Column[];
       groupBy?: string[];
       sortBy?: Sort[];
       filters?: Filter[];
       displayFields?: {
         primary?: string;   // 主要显示字段
         secondary?: string[]; // 次要显示字段
         media?: string;     // 媒体字段
         group?: string;     // 分组字段
       };
     };
   }
   ```

3. 状态管理
   ```typescript
   const viewConfigAtom = atom<ViewConfig>({
     type: 'table',
     settings: defaultSettings
   });

   const viewDataAtom = atom(async (get) => {
     const config = get(viewConfigAtom);
     const data = await dataSource.fetch();
     return processData(data, config);
   });
   ```

### 性能优化策略
1. 虚拟化渲染
   - 表格行虚拟化
   - 看板列虚拟化
   - 画廊图片懒加载

2. 状态管理优化
   - 原子化更新
   - 选择性重渲染
   - 状态分片

3. 渲染优化
   - React.memo 优化
   - 使用 CSS 动画
   - 批量更新策略

### 协作功能
1. 实时更新
   - 乐观更新
   - 冲突解决
   - 状态同步

2. 并发控制
   - 锁机制
   - 版本控制
   - 变更追踪

## 开发顺序

1. 第一阶段：基础框架
   1. 表格引擎集成
   2. 视图切换系统
   3. 字段动态配置

2. 第二阶段：核心视图
   1. 表格视图完整功能
   2. 看板视图基础功能
   3. 画廊视图基础功能

3. 第三阶段：高级功能
   1. 性能优化
   2. 协作功能
   3. 高级交互

4. 第四阶段：扩展视图
   1. 信息流视图
   2. 文章连读视图
   3. 自定义视图支持

## 注意事项

1. 性能关注点
   - 大数据量渲染优化
   - 实时更新性能
   - 内存占用控制

2. 用户体验
   - 响应式设计
   - 快捷键支持
   - 动画过渡
   - 错误处理

3. 开发规范
   - TypeScript 类型完整性
   - 组件复用性
   - 测试覆盖
   - 文档完整性
